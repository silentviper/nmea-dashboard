{"version":3,"file":"useSignalk-Bw-wFA2A.js","sources":["../../src/composables/useSignalk.ts"],"sourcesContent":["interface SignalKValue {\n\tpath: string;\n\tvalue: any;\n\ttimestamp?: string;\n}\n\ninterface SignalKUpdate {\n\ttimestamp: string;\n\tvalues: SignalKValue[];\n}\n\ninterface SignalKMessage {\n\tcontext: string;\n\tupdates: SignalKUpdate[];\n}\n\ninterface SignalKSubscription {\n\tpath: string;\n\tperiod?: number;\n\tformat?: string;\n\tpolicy?: string;\n\tminPeriod?: number;\n}\n\ninterface SignalKConfig {\n\tport?: number;\n\thost?: string;\n\tprotocol?: 'http' | 'ws';\n\tapiVersion?: string;\n}\n\nconst DEFAULT_CONFIG: SignalKConfig = {\n\tport: 3000,\n\thost: window.location.hostname,\n\tprotocol: 'ws',\n\tapiVersion: 'v1',\n};\n\nexport class SignalKWebSocket {\n\tprivate ws: WebSocket | null = null;\n\tprivate reconnectAttempts = 0;\n\tprivate maxReconnectAttempts = 5;\n\tprivate reconnectTimeout = 1000;\n\tprivate subscriptions = new Set<SignalKSubscription>();\n\tprivate messageHandlers = new Set<(message: SignalKMessage) => void>();\n\tprivate config: SignalKConfig;\n\n\tconstructor(config: Partial<SignalKConfig> = {}) {\n\t\tthis.config = { ...DEFAULT_CONFIG, ...config };\n\t}\n\n\tprivate get baseUrl() {\n\t\treturn `${this.config.protocol === 'ws' ? 'ws' : 'http'}://${\n\t\t\tthis.config.host\n\t\t}:${this.config.port}/signalk/${this.config.apiVersion}`;\n\t}\n\n\tprivate get wsUrl() {\n\t\treturn `${this.baseUrl}/stream?subscribe=none`;\n\t}\n\n\tprivate get httpUrl() {\n\t\treturn `${\n\t\t\tthis.config.protocol === 'ws' ? 'http' : this.config.protocol\n\t\t}://${this.config.host}:${this.config.port}/signalk/${\n\t\t\tthis.config.apiVersion\n\t\t}`;\n\t}\n\n\tconnect() {\n\t\ttry {\n\t\t\tthis.ws = new WebSocket(this.wsUrl);\n\n\t\t\tthis.ws.onopen = () => {\n\t\t\t\tconsole.log('SignalK WebSocket connected');\n\t\t\t\tthis.reconnectAttempts = 0;\n\t\t\t\tthis.resubscribe();\n\t\t\t};\n\n\t\t\tthis.ws.onclose = () => {\n\t\t\t\tconsole.log('SignalK WebSocket closed');\n\t\t\t\tthis.handleDisconnect();\n\t\t\t};\n\n\t\t\tthis.ws.onerror = (error) => {\n\t\t\t\tconsole.error('SignalK WebSocket error:', error);\n\t\t\t\tthis.handleDisconnect();\n\t\t\t};\n\n\t\t\tthis.ws.onmessage = (event) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst message: SignalKMessage = JSON.parse(event.data);\n\t\t\t\t\tthis.messageHandlers.forEach((handler) => handler(message));\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error('Error parsing SignalK WebSocket message:', error);\n\t\t\t\t}\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tconsole.error('Error creating SignalK WebSocket:', error);\n\t\t\tthis.handleDisconnect();\n\t\t}\n\t}\n\n\tprivate handleDisconnect() {\n\t\tif (this.reconnectAttempts < this.maxReconnectAttempts) {\n\t\t\tthis.reconnectAttempts++;\n\t\t\tconst timeout =\n\t\t\t\tthis.reconnectTimeout * Math.pow(2, this.reconnectAttempts - 1);\n\t\t\tconsole.log(\n\t\t\t\t`Attempting to reconnect to SignalK in ${timeout}ms (attempt ${this.reconnectAttempts})`\n\t\t\t);\n\t\t\tsetTimeout(() => this.connect(), timeout);\n\t\t} else {\n\t\t\tconsole.error('Max reconnection attempts to SignalK reached');\n\t\t}\n\t}\n\n\tsubscribe(subscription: SignalKSubscription) {\n\t\tthis.subscriptions.add(subscription);\n\t\tif (this.isConnected()) {\n\t\t\tthis.sendSubscription(subscription);\n\t\t}\n\t}\n\n\tprivate resubscribe() {\n\t\tif (this.subscriptions.size > 0) {\n\t\t\tconst request = {\n\t\t\t\tcontext: 'vessels.self',\n\t\t\t\tsubscribe: Array.from(this.subscriptions),\n\t\t\t};\n\t\t\tthis.ws?.send(JSON.stringify(request));\n\t\t}\n\t}\n\n\tprivate sendSubscription(subscription: SignalKSubscription) {\n\t\tconst request = {\n\t\t\tcontext: 'vessels.self',\n\t\t\tsubscribe: [subscription],\n\t\t};\n\t\tthis.ws?.send(JSON.stringify(request));\n\t}\n\n\t// HTTP API methods\n\tasync put(path: string, value: any, token?: string) {\n\t\tconst url = `${this.httpUrl}/api/vessels/self/${path.replace(/\\./g, '/')}`;\n\t\tconst headers: Record<string, string> = {\n\t\t\t'Content-Type': 'application/json',\n\t\t};\n\n\t\tif (token) {\n\t\t\theaders['Authorization'] = `Bearer ${token}`;\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await fetch(url, {\n\t\t\t\tmethod: 'PUT',\n\t\t\t\theaders,\n\t\t\t\tbody: JSON.stringify({ value }),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tthrow new Error(`HTTP error! status: ${response.status}`);\n\t\t\t}\n\n\t\t\treturn await response.json();\n\t\t} catch (error) {\n\t\t\tconsole.error('Error making SignalK PUT request:', error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\taddMessageHandler(handler: (message: SignalKMessage) => void) {\n\t\tthis.messageHandlers.add(handler);\n\t}\n\n\tremoveMessageHandler(handler: (message: SignalKMessage) => void) {\n\t\tthis.messageHandlers.delete(handler);\n\t}\n\n\tisConnected(): boolean {\n\t\treturn this.ws?.readyState === WebSocket.OPEN;\n\t}\n\n\tdisconnect() {\n\t\tthis.ws?.close();\n\t\tthis.ws = null;\n\t\tthis.subscriptions.clear();\n\t\tthis.messageHandlers.clear();\n\t}\n}\n\nexport function useSignalK(config: Partial<SignalKConfig> = {}) {\n\tconst signalK = new SignalKWebSocket({ ...DEFAULT_CONFIG, ...config });\n\n\treturn {\n\t\tconnect: () => signalK.connect(),\n\t\tdisconnect: () => signalK.disconnect(),\n\t\tsubscribe: (subscription: SignalKSubscription) =>\n\t\t\tsignalK.subscribe(subscription),\n\t\taddMessageHandler: (handler: (message: SignalKMessage) => void) =>\n\t\t\tsignalK.addMessageHandler(handler),\n\t\tremoveMessageHandler: (handler: (message: SignalKMessage) => void) =>\n\t\t\tsignalK.removeMessageHandler(handler),\n\t\tisConnected: () => signalK.isConnected(),\n\t\tput: (path: string, value: any, token?: string) =>\n\t\t\tsignalK.put(path, value, token),\n\t};\n}\n"],"names":["DEFAULT_CONFIG","SignalKWebSocket","config","__publicField","error","event","message","handler","timeout","subscription","_a","request","path","value","token","url","headers","response","useSignalK","signalK"],"mappings":"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"}